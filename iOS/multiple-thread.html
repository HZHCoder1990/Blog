<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>陈希的学习笔记</title><meta name="description" content="">
    <link rel="preload" href="/blog/assets/js/runtime~app.a9d266aa.js" as="script"><link rel="preload" href="/blog/assets/css/styles.f16aad9d.css" as="style"><link rel="preload" href="/blog/assets/js/1812.4170f11f.js" as="script"><link rel="preload" href="/blog/assets/js/app.72f3745a.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/styles.f16aad9d.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt="陈希的学习笔记"><span class="site-name can-hide">陈希的学习笔记</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/blog/iOS/" class="nav-link router-link-active" aria-label="iOS"><!--[--><!--]--> iOS <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/shell/" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/data-structure/" class="nav-link" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/database/" class="nav-link" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Vue/" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/others/" class="nav-link" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/chenxi92/blog.git" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/blog/iOS/" class="nav-link router-link-active" aria-label="iOS"><!--[--><!--]--> iOS <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/shell/" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/data-structure/" class="nav-link" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/database/" class="nav-link" aria-label="数据库"><!--[--><!--]--> 数据库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Vue/" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/others/" class="nav-link" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/chenxi92/blog.git" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a href="/blog/iOS/" class="nav-link router-link-active sidebar-heading sidebar-item active" aria-label="iOS"><!--[--><!--]--> iOS <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/blog/iOS/app-launch.md" class="nav-link sidebar-item" aria-label="App 启动"><!--[--><!--]--> App 启动 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/attribute.md" class="nav-link sidebar-item" aria-label="attribute"><!--[--><!--]--> attribute <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/autolayout.md" class="nav-link sidebar-item" aria-label="AutoLayout 布局"><!--[--><!--]--> AutoLayout 布局 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/bug-track.md" class="nav-link sidebar-item" aria-label="Bug 追踪"><!--[--><!--]--> Bug 追踪 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/create-certificate.md" class="nav-link sidebar-item" aria-label="创建开发证书"><!--[--><!--]--> 创建开发证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/dispatch-semaphore.md" class="nav-link sidebar-item" aria-label="信号量"><!--[--><!--]--> 信号量 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/install-ipa-from-safari.md" class="nav-link sidebar-item" aria-label="iPA 文件安装"><!--[--><!--]--> iPA 文件安装 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/isa.md" class="nav-link sidebar-item" aria-label="isa 指针"><!--[--><!--]--> isa 指针 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/keychain.md" class="nav-link sidebar-item" aria-label="钥匙串学习"><!--[--><!--]--> 钥匙串学习 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/libmobiledevice.md" class="nav-link sidebar-item" aria-label="libmobiledevice"><!--[--><!--]--> libmobiledevice <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/method-forward.md" class="nav-link sidebar-item" aria-label="消息转发"><!--[--><!--]--> 消息转发 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/multiple-thread.md" class="nav-link sidebar-item active" aria-label="多线程"><!--[--><!--]--> 多线程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/security.md" class="nav-link sidebar-item" aria-label="security"><!--[--><!--]--> security <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/symbols.md" class="nav-link sidebar-item" aria-label="符号表"><!--[--><!--]--> 符号表 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/tips.md" class="nav-link sidebar-item" aria-label="iOS 开发小知识"><!--[--><!--]--> iOS 开发小知识 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/UIScrollview.md" class="nav-link sidebar-item" aria-label="UIScrollView 约束"><!--[--><!--]--> UIScrollView 约束 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/2-unity-ios-bridge.md" class="nav-link sidebar-item" aria-label="iOS &amp; Unity 相互调用"><!--[--><!--]--> iOS &amp; Unity 相互调用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/vapor-tutorial.md" class="nav-link sidebar-item" aria-label="Vapor 学习"><!--[--><!--]--> Vapor 学习 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/xcode-shortcut.md" class="nav-link sidebar-item" aria-label="Xcode 快捷键"><!--[--><!--]--> Xcode 快捷键 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><p class="sidebar-item">面试</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/iOS/interview/0-interview-question.md" class="nav-link sidebar-item" aria-label="面试题"><!--[--><!--]--> 面试题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/interview/1-category-and-extension.md" class="nav-link sidebar-item" aria-label="Category &amp; Extension"><!--[--><!--]--> Category &amp; Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/interview/2-atomic.md" class="nav-link sidebar-item" aria-label="原子性"><!--[--><!--]--> 原子性 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/interview/3-weak.md" class="nav-link sidebar-item" aria-label="Weak"><!--[--><!--]--> Weak <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/interview/4-associated-object.md" class="nav-link sidebar-item" aria-label="关联对象"><!--[--><!--]--> 关联对象 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/interview/property.md" class="nav-link sidebar-item" aria-label="属性"><!--[--><!--]--> 属性 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">源码学习</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/iOS/open-analysis/AFNetworking.md" class="nav-link sidebar-item" aria-label="AFNetworking"><!--[--><!--]--> AFNetworking <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/open-analysis/Aspects.md" class="nav-link sidebar-item" aria-label="Aspects"><!--[--><!--]--> Aspects <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/iOS/open-analysis/Masonry.md" class="nav-link sidebar-item" aria-label="Masonry"><!--[--><!--]--> Masonry <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="多线程技术方案" tabindex="-1"><a class="header-anchor" href="#多线程技术方案" aria-hidden="true">#</a> 多线程技术方案</h2><p><a href="#pthread">1. pthread</a></p><p><a href="#NSThread">2. NSThread</a></p><p><a href="#GCD">3. GCD</a></p><p><a href="#NSOperation">4. NSOperation</a></p><h3 id="_1-pthread" tabindex="-1"><a class="header-anchor" href="#_1-pthread" aria-hidden="true">#</a> <a name="pthread"></a>1.pthread</h3><p><strong>特点</strong></p><p>程序员自己管理线程的生命周期</p><p><strong>定义</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>线程库实行了POSIX线程标准通常称为Pthreads。
POSIX线程具有很好的可移植性，使用pthreads编写的代码可运行于Solaris、FreeBSD、Linux 等平台，Windows平台亦有pthreads-win32可供使用 。
Pthreads定义了一套C语言的类型、函数与常量，它以pthread.h头文件和一个线程库实现。
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>头文件</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#import &lt;pthread.h&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><strong>创建线程</strong></p><div class="language-objective ext-objective line-numbers-mode"><pre class="language-objective"><code>/**

- (void)demo {

    
    //1.创建线程对象
    pthread_t thread;
    
    /**2.创建线程
    参数：
     1.指向线程标识符的指针，C 语言中类型的结尾通常 _t/Ref，而且不需要使用 *;
     2.用来设置线程属性;
     3.指向函数的指针,传入函数名(函数的地址)，线程要执行的函数/任务;
     4.运行函数的参数;
     */
    NSString *param = @&quot;参数&quot;;
    int result = pthread_create(&amp;thread, NULL, func, (__bridge void *)(param));
    if (result == 0) {
    	NSLog(@&quot;success&quot;)
    } else {
    	NSLog(@&quot;failure&quot;);
    	return;
    }
    
    //3.设置子线程的状态设置为detached,则该线程运行结束后会自动释放所有资源，或者在子线程中添加 pthread_detach(pthread_self()),其中pthread_self()是获得线程自身的id
    pthread_detach(thread);
 }
 
 void *func(void *param) {
	//在此做耗时操作
    NSLog(@&quot;new thread : %@  参数是: %@&quot;,[NSThread currentThread],(__bridge NSString *)(param));
    
    return NULL;
 }
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>其他函数</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>pthread_t：线程ID
pthread_attr_t：线程属性
pthread_create()：创建一个线程
pthread_exit()：终止当前线程
pthread_cancel()：中断另外一个线程的运行
pthread_join()：阻塞当前的线程，直到另外一个线程运行结束
pthread_attr_init()：初始化线程的属性
pthread_attr_setdetachstate()：设置脱离状态的属性（决定这个线程在终止时是否可以被结合）
pthread_attr_getdetachstate()：获取脱离状态的属性
pthread_attr_destroy()：删除线程的属性
pthread_kill()：向线程发送一个信号
pthread_equal(): 对两个线程的线程标识号进行比较
pthread_detach(): 分离线程
pthread_self(): 查询线程自身线程标识号
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_2-nsthread" tabindex="-1"><a class="header-anchor" href="#_2-nsthread" aria-hidden="true">#</a> <a name="NSThread"></a>2.NSThread</h3><p><strong>特点</strong></p><p>程序员管理线程的生命周期；</p><p>使用OC对象， 简单易用，可直接操作线程对象</p><p><strong>创建方式</strong></p><p><strong>1. 实例方法创建线程</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)useInstanceMehotd:(id)sender {
    NSLog(@&quot;===== begin %@&quot;, [NSThread currentThread]);
    // 创建NSThread 对象
    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(myOperation:) object:@&quot;instance method&quot;];
    // 启动线程 -&gt; 开辟子线程执行方法
    [thread start];
    NSLog(@&quot;===== end %@&quot;, [NSThread currentThread]);
}

- (void)myOperation:(id)param {
    NSLog(@&quot;begin %@&quot;, [NSThread currentThread]);
    NSLog(@&quot;param = %@&quot;, param);
    [NSThread sleepForTimeInterval:3];
    NSLog(@&quot;end %@&quot;, [NSThread currentThread]);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>2. 类方法创建线程</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)useClassMethod:(id)sender {
    NSLog(@&quot;===== begin %@&quot;, [NSThread currentThread]);
    // 自动创建线程，并执行方法
    [NSThread detachNewThreadSelector:@selector(myOperation:) toTarget:self withObject:@&quot;class method&quot;];
    NSLog(@&quot;===== end %@&quot;, [NSThread currentThread]);

}

- (void)myOperation:(id)param {
    NSLog(@&quot;begin %@&quot;, [NSThread currentThread]);
    NSLog(@&quot;param = %@&quot;, param);
    [NSThread sleepForTimeInterval:3];
    NSLog(@&quot;end %@&quot;, [NSThread currentThread]);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>3. NSObject分类方法创建线程</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)useCatgoryMethod:(id)sender {
    NSLog(@&quot;===== begin %@&quot;, [NSThread currentThread]);
    // 是NSObject分类方法
    // 自动在后台线程执行
    [self performSelectorInBackground:@selector(myOperation:) withObject:@&quot;category method&quot;];
    NSLog(@&quot;===== end %@&quot;, [NSThread currentThread]);
}

- (void)myOperation:(id)param {
    NSLog(@&quot;begin %@&quot;, [NSThread currentThread]);
    NSLog(@&quot;param = %@&quot;, param);
    [NSThread sleepForTimeInterval:3];
    NSLog(@&quot;end %@&quot;, [NSThread currentThread]);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-gcd" tabindex="-1"><a class="header-anchor" href="#_3-gcd" aria-hidden="true">#</a> <a name="GCD"></a>3.GCD</h3><p><strong>特点</strong></p><p>不用关心线程的生命周期</p><p><strong>执行任务方式</strong></p><ol><li>同步的方式执行：</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>dispatch_sync(dispatch_queue_t queue, dispatch_block_t block);
queue: 队列
block: 任务
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>异步的方式执行</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
queue: 队列
block: 任务


同步：
只能在当前线程中执行任务， 不具备开启线程能力
必须等待任务执行完毕，才会执行下一条语句

异步：
可以在新的线程中执行， 具备开启新线程能力
不用等待任务执行完毕， 就可以执行下一条语句
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>队列类型</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>1. 并发队列(Concurrent Dispatch Queue)
   * 允许多个任务并发（同时）执行
   * 并发功能只有在异步函数下才有效
2. 串行队列（Serial Dispatch Queue)
   * 让任务一个接着一个的执行

全局队列（dispatch_get_global_queue): 是一个并发队列
主队列（dispatch_get_main_queue): 主队列专门用于在主线程上执行任务， 是一个串行队列
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>队列执行效果</strong></p><table><thead><tr><th style="text-align:center;"></th><th style="text-align:left;">并发队列</th><th style="text-align:left;">串行队列</th></tr></thead><tbody><tr><td style="text-align:center;"><strong>同步</strong></td><td style="text-align:left;">1.没有开启新线程<br>2.串行执行任务</td><td style="text-align:left;">1. 没有开启新线程<br>2. 串行执行任务</td></tr><tr><td style="text-align:center;"><strong>异步</strong></td><td style="text-align:left;">1. 开启新线程<br>2. 并发执行任务</td><td style="text-align:left;">1. 开启新线程<br>2. 串行执行任务</td></tr></tbody></table><h4 id="dispatch-barrier-async-使用" tabindex="-1"><a class="header-anchor" href="#dispatch-barrier-async-使用" aria-hidden="true">#</a> dispatch_barrier_async 使用</h4><blockquote><p>该函数会等待dispatch_barrier_async 前面所有任务完成</p></blockquote><blockquote><p>然后在执行 dispatch_barrier_async 的任务</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)test_barrier_async:(id)sender {
    dispatch_queue_t queue = dispatch_queue_create(&quot;com.chenxi.learn.thread&quot;, DISPATCH_QUEUE_CONCURRENT);
    
    dispatch_async(queue, ^{
        [NSThread sleepForTimeInterval:2];
        NSLog(@&quot;task1 complete, %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        [NSThread sleepForTimeInterval:1];
        NSLog(@&quot;task2 complete, %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        int time = arc4random() % 5;
        [NSThread sleepForTimeInterval:time];
        NSLog(@&quot;task3 complete, %@&quot;, [NSThread currentThread]);
    });
    
    // 阻塞
    dispatch_barrier_async(queue, ^{
        NSLog(@&quot;barrier asycn task ..., %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        [NSThread sleepForTimeInterval:3];
        NSLog(@&quot;another task1 complete, %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        [NSThread sleepForTimeInterval:1];
        NSLog(@&quot;another task2 complete, %@&quot;, [NSThread currentThread]);
    });
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="gcd-调度组" tabindex="-1"><a class="header-anchor" href="#gcd-调度组" aria-hidden="true">#</a> GCD 调度组</h4><blockquote><p>使用 dispatch_group_async 和 dispatch_group_notify 函数来完成调度组的工作</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (void)demo {
    
    // 1. 调度组
    dispatch_group_t group = dispatch_group_create();
    
    // 2. 并发队列
    dispatch_queue_t queue = dispatch_queue_create(&quot;com.chenxi.learn.thread&quot;, DISPATCH_QUEUE_CONCURRENT);
    
    // 3. 任务添加到调度组
    dispatch_group_async(group, queue, ^{
        [NSThread sleepForTimeInterval:3];
        NSLog(@&quot;task1 comolete, %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_group_async(group, queue, ^{
        [NSThread sleepForTimeInterval:1];
        NSLog(@&quot;task2 comolete, %@&quot;, [NSThread currentThread]);
    });
    
    dispatch_group_async(group, queue, ^{
        [NSThread sleepForTimeInterval:2];
        NSLog(@&quot;task3 comolete, %@&quot;, [NSThread currentThread]);
    });
    
    // 等待所有任务离开调度组， 调用该函数
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        NSLog(@&quot;all task completed, %@&quot;, [NSThread currentThread]);
    });
    
    NSLog(@&quot;other things ...&quot;);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_4-nsoperation" tabindex="-1"><a class="header-anchor" href="#_4-nsoperation" aria-hidden="true">#</a> <a name="NSOperation"></a>4. NSOperation</h4><p><strong>特点</strong></p><blockquote><p>是使用OC语言对GCD的封装</p></blockquote><blockquote><p>完全面向对象，不需要管理线程的生命周期</p></blockquote><p>NSOperation 只是一个抽象类， 需要使用子类来执行任务。 苹果提供了两个子类： NSInvocationOperation 和 NSBlockOperation。</p><p><strong>核心</strong></p><blockquote><p>操作(NSoperation)： 要做的事情</p></blockquote><blockquote><p>队列(NSOperationQueue): 存放操作</p></blockquote><p><strong>使用步骤</strong></p><blockquote><p>创建操作</p></blockquote><blockquote><p>创建队列</p></blockquote><blockquote><p>将操作放入队列</p></blockquote><h5 id="nsinvocationoperation-使用" tabindex="-1"><a class="header-anchor" href="#nsinvocationoperation-使用" aria-hidden="true">#</a> NSInvocationOperation 使用</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)tes_invocation:(id)sender {
    
    NSInvocationOperation *invocationOperation = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(demo:) object:@{@&quot;name&quot;:@&quot;invocationOperation&quot;, @&quot;param&quot;: @&quot;hello world&quot;}];
    
    // 操作完成回调
    [invocationOperation setCompletionBlock:^{
        NSLog(@&quot;end invocation thread = %@&quot;, [NSThread currentThread]);
    }];
    
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    
    [queue addOperation:invocationOperation];
}

- (void)demo:(id)obj {
    [NSThread sleepForTimeInterval:arc4random()%4];
    NSLog(@&quot;thread = %@, msg = %@&quot;, [NSThread currentThread], obj);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h5 id="nsblockoperation" tabindex="-1"><a class="header-anchor" href="#nsblockoperation" aria-hidden="true">#</a> NSBlockOperation</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)test_block:(id)sender {
    
    NSBlockOperation *blockOperation = [NSBlockOperation blockOperationWithBlock:^{
        [NSThread sleepForTimeInterval:3];
        NSLog(@&quot;block operation 1, thread = %@&quot;, [NSThread currentThread]);
    }];
    
    // 可以添加多个任务
    [blockOperation addExecutionBlock:^{
        [NSThread sleepForTimeInterval:1];
        NSLog(@&quot;block operation 2, thread = %@&quot;, [NSThread currentThread]);
    }];
    
    [blockOperation addExecutionBlock:^{
        [NSThread sleepForTimeInterval:1.5];
        NSLog(@&quot;block operation 3, thread = %@&quot;, [NSThread currentThread]);
    }];
    
    [blockOperation setCompletionBlock:^{
        NSLog(@&quot;end block operation, thread = %@&quot;, [NSThread currentThread]);
    }];
    
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    
    [queue addOperation:blockOperation];
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h5 id="操作依赖" tabindex="-1"><a class="header-anchor" href="#操作依赖" aria-hidden="true">#</a> 操作依赖</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (IBAction)test_dependency:(id)sender {
    
    _queue = [[NSOperationQueue alloc] init];
    
    NSBlockOperation *op1 = [NSBlockOperation blockOperationWithBlock:^{
        [NSThread sleepForTimeInterval:3];
        NSLog(@&quot;op1 , thread = %@&quot;, [NSThread currentThread]);
    }];
    
    NSBlockOperation *op2 = [NSBlockOperation blockOperationWithBlock:^{
        [NSThread sleepForTimeInterval:2];
        NSLog(@&quot;op2 , thread = %@&quot;, [NSThread currentThread]);
    }];
    
    NSBlockOperation *op3 = [NSBlockOperation blockOperationWithBlock:^{
        [NSThread sleepForTimeInterval:0.5];
        NSLog(@&quot;op3 , thread = %@&quot;, [NSThread currentThread]);
    }];
    
    // op1 完成之后，开始op2 / op3 任务
    [op2 addDependency:op1];
    [op3 addDependency:op1];
    
    [_queue addOperation:op1];
    [_queue addOperation:op2];
    [_queue addOperation:op3];
    
    NSLog(@&quot;test dependency , thread = %@&quot;, [NSThread currentThread]);
}

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h5 id="自定义nsoperation" tabindex="-1"><a class="header-anchor" href="#自定义nsoperation" aria-hidden="true">#</a> 自定义NSOperation</h5><blockquote><p>自定义 Operation 需要继承 NSOperation 类，并实现其 main() 方法，因为在调用 start() 方法的时候，内部会调用 main() 方法完成相关逻辑。</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// 创建 CustomOperation 类， 继承自 NSOperation
@interface CustomOperation : NSOperation
@end

@implementation CustomOperation

- (void)main
{
    NSTimeInterval time = arc4random() % 6;
    [NSThread sleepForTimeInterval:time];
    NSLog(@&quot;thread %@&quot;, [NSThread currentThread]);
}

@end

// ======= 在其他文件调用

- (IBAction)test_custom_operation:(id)sender {
    
    CustomOperation *operation1 = [[CustomOperation alloc] init];
    CustomOperation *operation2 = [[CustomOperation alloc] init];
    
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    
    [queue addOperation:operation1];
    [queue addOperation:operation2];
}

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h5 id="队列其他方法" tabindex="-1"><a class="header-anchor" href="#队列其他方法" aria-hidden="true">#</a> 队列其他方法</h5><blockquote><p>maxConcurrentOperationCount 这是最大并发数</p></blockquote><blockquote><p>suspended 队列暂停/继续</p></blockquote><blockquote><p>cancelAllOperations 取消所有操作</p></blockquote><h4 id="常见面试题" tabindex="-1"><a class="header-anchor" href="#常见面试题" aria-hidden="true">#</a> 常见面试题</h4><p>下面代码会输出什么？ 为什么？</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- (void)viewDidLoad {
	[super viewDidLoad];
	NSLog(@&quot;1&quot;);
   	dispatch_sync(dispatch_get_main_queue(), ^{
        NSLog(@&quot;2&quot;);
    });
    NSLog(@&quot;3&quot;);
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="答案" tabindex="-1"><a class="header-anchor" href="#答案" aria-hidden="true">#</a> 答案</h5><p><strong>输出: 1</strong>， 然后崩溃</p><h5 id="原因" tabindex="-1"><a class="header-anchor" href="#原因" aria-hidden="true">#</a> 原因</h5><p>系统维护的<code>dispatch_get_main_queue()</code>这个队列里面在执行<code>viewDidLoad</code>方法，在<code>viewDidLoad</code>中又再次在<code>dispatch_get_main_queue()</code>这个相同的队列里面执行<code>block</code>方法。</p><p>由于串行队列<code>FIFO</code>原则，系统维护的<code>dispatch_get_main_queue()</code>先进栈，所以要先执行完毕后，再执行后进栈的队列任务，而系统维护的<code>dispatch_get_main_queue()</code>执行完的条件时<code>viewDidLoad</code>方法执行完毕，所以系统维护的<code>dispatch_get_main_queue()</code>会等待<code>dispatch_sync</code>调用的<code>dispatch_get_main_queue()</code>执行完毕，<code>dispatch_sync</code>调用的<code>dispatch_get_main_queue()</code>又在等待先进栈的系统维护的<code>dispatch_get_main_queue()</code>执行完毕，这样就陷入死循环.</p><p>下面代码崩溃原因同上：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>dispatch_queue_t queue = dispatch_queue_create(NULL, DISPATCH_QUEUE_SERIAL);
dispatch_async(queue, ^{
    NSLog(@&quot;1&quot;);
    dispatch_sync(queue, ^{
        NSLog(@&quot;2&quot;);
    });
    NSLog(@&quot;3&quot;);
});
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>输出1，然后崩溃</p><h5 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h5><ol><li><a href="https://www.jianshu.com/p/0b0d9b1f1f19" target="_blank" rel="noopener noreferrer">关于iOS多线程，你看我就够了<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ol><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/chenxi92/blog.git/edit/main/iOS/multiple-thread.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新时间: </span><span class="meta-item-info">2021/10/11 下午4:56:57</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: peak@jiemogame.com">peak</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/blog/assets/js/runtime~app.a9d266aa.js" defer></script><script src="/blog/assets/js/1812.4170f11f.js" defer></script><script src="/blog/assets/js/app.72f3745a.js" defer></script>
  </body>
</html>
